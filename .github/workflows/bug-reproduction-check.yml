# This workflow triggers when a new issue is opened or when a user comments '@bot recheck' on an existing issue.
# It analyzes bug reports to ensure they contain sufficient information for reproduction.
# The AI checks for: steps to reproduce, expected vs actual behavior, and environment details.
# If information is missing, it posts an interactive checklist asking the reporter to provide more details.
# Reporters can update their issue and comment '@bot recheck' to trigger re-analysis.
#
# Model: mistral-ai/ministral-3b can be changed inline. This model is best suited for fast, lightweight tasks.

name: Bug Report Reproduction Check
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  models: read

jobs:
  reproduction-steps-check:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' || 
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@bot recheck'))
    steps:
      - name: Fetch Issue
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            })
            core.setOutput('title', issue.data.title)
            core.setOutput('body', issue.data.body)

      - name: Analyze Issue For Reproduction
        if: contains(join(github.event.issue.labels.*.name, ','), 'bug')
        id: analyze-issue
        uses: actions/ai-inference@v1
        with:
          model: mistral-ai/ministral-3b
          system-prompt: |
            Given a bug report title and text for a web application, return 'pass' if there is enough information to reliably reproduce the issue, meaning the report clearly describes the steps to reproduce the problem, specifies the expected and actual behavior, and includes environment details such as browser and operating system; if any of these elements are missing or unclear, return a brief description of what is missing in a friendly response to the author instead of 'pass'. Consider the following title and body:
          prompt: |
            Title: ${{ steps.issue.outputs.title }}
            Body: ${{ steps.issue.outputs.body }}

      - name: Comment with Interactive Checklist
        if: contains(join(github.event.issue.labels.*.name, ','), 'bug') && steps.analyze-issue.outputs.response != 'pass'
        uses: actions/github-script@v7
        with:
          script: |
            const aiResponse = `${{ steps.analyze-issue.outputs.response }}`;
            const body = `
            ## ðŸ“‹ Bug Report Checklist
            
            ${aiResponse}
            
            **Please update your issue with:**
            - [ ] Clear steps to reproduce
            - [ ] Expected behavior
            - [ ] Actual behavior
            - [ ] Environment details (browser, OS, version)
            - [ ] Screenshots or error messages (if applicable)
            - [ ] Console logs (if applicable)
            
            Once you've added this information, comment \`@bot recheck\` and I'll re-evaluate!
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
